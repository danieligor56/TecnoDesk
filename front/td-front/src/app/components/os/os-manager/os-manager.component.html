<div class="container">
    <div class="loading-overlay" *ngIf="isLoading">
        <mat-spinner diameter="50"></mat-spinner>
    </div>

    <div class="titPage" style="padding:5px;margin-bottom: 10px;">
        <h1 id="osH1">Ordem de servi√ßo</h1>
    </div>

    <mat-tab-group mat-align-tabs="start" animationDuration="500ms" style="overflow: hidden;">




        <mat-tab label="Ordem de servi√ßo">


            <!-- <div style="width: 32rem; margin-left: .5rem;">
            <mat-form-field appearance="fill" >
                <mat-label>Status OS </mat-label>
                <mat-select>
                    <mat-option> CRUZEIRO </mat-option>
                </mat-select>
            </mat-form-field>
        </div> -->

            <div class="tab-content" style="display: flex;">



                <div class="os-dados">

                    <div>
                        <h1 class="label" style="margin-bottom: .2rem;">N√∫mero da OS:<b>{{Os?.sequencial}} üìã</b></h1>
                    </div>

                    <div class="cliente-os">
                        <h3>Cliente</h3>
                        <!-- Primeira linha: Nome e C√≥digo -->
                        <div class="row">
                            <div class="input-group">
                                <label for="cliente">Nome:</label>
                                <input type="text" id="cliente" [value]="Os?.cliente?.nome" readonly>
                            </div>
                            <div class="input-group" style="width: 80px;">
                                <label for="cod">Cod.:</label>
                                <input type="text" id="cod" [value]="Os?.cliente?.id" readonly>
                            </div>
                        </div>

                        <!-- Segunda linha: Endere√ßo e Telefone -->
                        <div class="row">
                            <div class="input-group">
                                <label for="telefone">Telefone:</label>
                                <input type="text" id="telefone" [value]="Os?.cliente?.cel1" readonly>
                            </div>
                            <div class="input-group" style="width: 250px;">
                                <label for="endereco">Endere√ßo:</label>
                                <input type="text" id="endereco"
                                    [value]="Os?.cliente?.logradouro + ', ' + Os?.cliente?.numero" readonly>
                            </div>
                        </div>

                        <!-- Terceira linha: Documento e Email -->
                        <div class="row">
                            <div class="input-group">
                                <label for="documento">Documento:</label>
                                <input type="text" id="documento" [value]="Os?.cliente?.documento" readonly>
                            </div>
                            <div class="input-group">
                                <label for="email">Email:</label>
                                <input type="text" id="email" [value]="Os?.cliente?.email" readonly>
                            </div>
                        </div>
                    </div>

                    <div id="parametros-os">
                        <h3>Parametros OS</h3>
                        <div style="width: 250px;margin-bottom: 1rem;">
                            <div class="input-group">
                                <label for="telefone">Respons√°vel pela abertura da Ordem de servi√ßo:</label>
                                <input type="text" id="telefone" [value]="Os?.colaborador?.nome" readonly width="80px">
                            </div>
                            <div style="display: flex;">
                                <div class="input-group">
                                    <mat-form-field appearance="legacy">
                                        <label for="telefone">Respons√°vel t√©cnico:</label>

                                        <mat-select [(ngModel)]="responsalveTecnico.id"
                                            (selectionChange)="onColaboradorChange($event.value)">
                                            <mat-option *ngFor="let colaborador of colaboradores"
                                                [value]="colaborador.id">
                                                {{ colaborador.nome }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <!-- <input type="text" id="telefone" value="" readonly> -->
                                </div>

                                <div class="input-group">
                                    <mat-form-field appearance="legacy" style="margin-left: .5rem;">
                                        <label>Tipo de prioridade: </label>
                                        <mat-select [(ngModel)]="prioridadeos" name="prioridadeos">
                                            <mat-option value=0>üìå Normal</mat-option>
                                            <mat-option value=1>üî• Cr√≠tica / Urgente / Emergencial</mat-option>
                                            <mat-option value=2>üîÑ Garantia</mat-option>
                                            <mat-option value=3>‚è±Ô∏è Prioridade</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>




                        </div>

                    </div>

                </div>


                <div class="rec-cli" style="margin-left: 30px;">
                    <h3 style="margin-bottom: 5px;">Resumo do problema</h3>

                    <div>
                        <div>
                            <mat-form-field class="dataCli" style="width: 400px; margin-right: 10px;" appearance="fill">
                                <mat-label>Reclama√ß√£o do cliente:</mat-label>
                                <textarea style="resize: none; height: 1 rem;" matInput placeholder=""
                                    readonly>{{Os?.reclamacaoCliente}}</textarea>
                            </mat-form-field>
                        </div>
                        <div style="margin-bottom: 2rem;">
                            <mat-form-field class="dataCli" style="width: 400px;" appearance="fill">
                                <mat-label>Resultado do teste inicial:</mat-label>
                                <textarea style="resize: none; height: 8px;" matInput placeholder=""
                                    readonly>{{Os?.initTest}}</textarea>
                            </mat-form-field>
                        </div>

                        <!-- <div id="containerImgOsManager">
                            <img src="/assets/img/img-manager-os.svg" alt="" id="imgOsManager">
                        </div> -->


                        <div>
                            <mat-form-field appearance="fill">
                                <mat-label><b>Definir status da Ordem de servi√ßo</b></mat-label>
                                <mat-select [(ngModel)]="statusOs" name="statusOS"
                                    (selectionChange)="alterStsOS($event)">
                                    <mat-option value="0">‚ö™Nova</mat-option>
                                    <mat-option value="1">üîµ Em andamento</mat-option>
                                    <mat-option value="2">üü° Aguardando aprova√ß√£o do or√ßamento</mat-option>
                                    <mat-option value="3">üü° Aguardando pe√ßas / materiais</mat-option>
                                    <mat-option value="4">üü° Aguardando cliente retirar</mat-option>
                                    <mat-option value="5">üü¢ Or√ßamento aprovado</mat-option>
                                    <mat-option value="6">üî¥ Pendente</mat-option>
                                    <mat-option value="7">üü¢ Conclu√≠da</mat-option>
                                    <mat-option value="8">‚ö´ Cancelada</mat-option>
                                    <mat-option value="9">‚úÖ Encerrada </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <button (click)="alterarTecnicoEPrioridade()" mat-stroked-button color="primary"
                            style="width: 100%;align-self: baseline;margin-bottom: .5rem;">Salvar</button>
                        <button [routerLink]="['/os/list']" mat-stroked-button color="basic"
                            style="width: 100%;align-self: baseline;">Voltar para lista</button>

                    </div>





                </div>

            </div>
        </mat-tab>

        <!-- Aba de Dados do Equipamento -->

        <mat-tab label="Equipamento" style="overflow: none;">

            <div class="tab-content" style="display: flex;">
                <div class="equipamento-dados">
                    <!-- <h3>Dados do Equipamento:</h3> -->
                    <div class="equip-os">
                        <h3 style="margin-bottom: 0px;">Equipamento</h3>
                        <!-- Segunda linha: Endere√ßo e Telefone  -->
                        <div class="row">
                            <div class="input-group">
                                <label for="telefone">Aparelho:</label>
                                <input type="text" id="telefone" value="{{Os?.aparelhos}}" readonly>
                            </div>
                            <div class="input-group" style="width: 250px;">
                                <label for="endereco">Marca:</label>
                                <input type="text" id="endereco" value="{{Os?.marcaAparelho}}" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-group">
                                <label for="documento">Modelo:</label>
                                <input type="text" id="documento" value="{{Os?.descricaoModelo}}" readonly>
                            </div>
                            <div class="input-group">
                                <label for="email">N√∫mero de s√©rie:</label>
                                <input type="text" id="email" value="{{Os?.snAparelho}}" readonly>
                            </div>

                        </div>
                        <div class="row">
                            <div>
                                <mat-form-field class="dataCli" style="width: 500px;margin-top: 8px;" appearance="fill">
                                    <mat-label>Estado do aparelho:</mat-label>
                                    <textarea style="resize: none;height: 102px;" value="{{Os?.checkList}}" matInput
                                        placeholder="" readonly></textarea>
                                    <mat-icon matSuffix>assignment</mat-icon>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="containerImgOsEquip">
                    <img src="/assets/img/img-os-manage-equip.svg" alt="">
                </div>

            </div>



        </mat-tab>

        <!-- Orcamento -->
        <!-- Aba de Servi√ßo -->
        <mat-tab label="Diagn√≥stico">
            <div class="tab-content">
                <div class="servico-dados">
                    <div id="laudoTecnico">


                        <div>
                            <h3>Laudo t√©cnico</h3>

                            <mat-form-field class="dataCli" appearance="fill">
                                <mat-label>Defeito reclamado pelo cliente: </mat-label>
                                <input disabled matInput>
                                {{Os?.reclamacaoCliente}}
                            </mat-form-field>

                            <mat-form-field class="dataCli" appearance="fill">
                                <mat-label>Resultado do teste inicial</mat-label>
                                <input disabled matInput>
                                {{Os?.initTest}}
                            </mat-form-field>

                            <mat-form-field class="fullWidth" appearance="fill">
                                <mat-label>Diagn√≥stico T√©cnico</mat-label>
                                <textarea matInput rows="4" style="resize: none;"
                                    placeholder="Informe o diagn√≥stico t√©cnico detalhado do equipamento, incluindo a descri√ß√£o do problema identificado e, se aplic√°vel, observa√ß√µes pertinentes ao reparo realizado ou recomendado"
                                    [(ngModel)]="Os.laudoTecnico" name="laudo"></textarea>
                                <button (click)="updateDiagnosticoTecnico()" mat-flat-button color="primary"
                                    style="align-self: baseline;margin-bottom: .5rem;">Salvar</button>
                            </mat-form-field>
                        </div>

                        <div>
                            <mat-form-field appearance="fill">
                                <mat-label><b>Definir status da Ordem de servi√ßo</b></mat-label>
                                <mat-select [(ngModel)]="statusOs" name="statusOS"
                                    (selectionChange)="alterStsOS($event)">
                                    <mat-option value="0">‚ö™Nova</mat-option>
                                    <mat-option value="1">üîµ Em andamento</mat-option>
                                    <mat-option value="2">üü° Aguardando aprova√ß√£o do or√ßamento</mat-option>
                                    <mat-option value="3">üü° Aguardando pe√ßas / materiais</mat-option>
                                    <mat-option value="4">üü° Aguardando cliente retirar</mat-option>
                                    <mat-option value="5">üü¢ Or√ßamento aprovado</mat-option>
                                    <mat-option value="6">üî¥ Pendente</mat-option>
                                    <mat-option value="7">üü¢ Conclu√≠da</mat-option>
                                    <mat-option value="8">‚ö´ Cancelada</mat-option>
                                    <mat-option value="9">‚úÖ Encerrada </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>


                    </div>
                </div>



            </div>
        </mat-tab>

        <!-- Aba de Servi√ßo -->
        <mat-tab label="Or√ßamento">
            <div class="tab-content">
                <div class="servico-dados">
                    <div id="orcamento" class="content-card">
                        <div class="card-header">
                            <div class="header-info">
                                <h3>Itens do Or√ßamento</h3>
                                <span class="item-count">{{dataSource.data.length}} itens adicionados</span>
                            </div>
                            <div class="header-actions">
                                <button mat-stroked-button color="primary"
                                    (click)="openListaServicoDialog(Os?.sequencial)">
                                    <mat-icon>build</mat-icon> + Servi√ßo
                                </button>
                                <button mat-stroked-button color="primary"
                                    (click)="openListaProdutoDialog(Os?.sequencial)">
                                    <mat-icon>shopping_cart</mat-icon> + Produto
                                </button>
                                <button mat-flat-button color="accent" (click)="openKitCreateDialog(Os?.sequencial)">
                                    <mat-icon>bolt</mat-icon> Montar Kit
                                </button>
                                <button [matMenuTriggerFor]="menuAvulso" mat-icon-button>
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                                <mat-menu #menuAvulso="matMenu">
                                    <button mat-menu-item (click)="openServicoAvulso(Os?.sequencial)">
                                        <mat-icon>add</mat-icon> Servi√ßo Avulso
                                    </button>
                                    <button mat-menu-item (click)="openProdutoAvulso(Os?.sequencial)">
                                        <mat-icon>add</mat-icon> Produto Avulso
                                    </button>
                                </mat-menu>
                            </div>
                        </div>

                        <div class="table-container">
                            <table mat-table [dataSource]="dataSource" matSort class="premium-table">

                                <ng-container matColumnDef="nome">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Item </th>
                                    <td mat-cell *matCellDef="let servico">
                                        <div class="item-cell">
                                            <mat-icon class="item-type-icon"
                                                [ngClass]="servico.produtoOuServico === 'SERVICO' ? 'icon-service' : 'icon-product'">
                                                {{servico.produtoOuServico === 'SERVICO' ? 'settings' : 'inventory_2'}}
                                            </mat-icon>
                                            <div class="item-details">
                                                <span class="item-name">{{servico.nomeServicoAvulso}}</span>
                                                <small class="item-category">{{servico.produtoOuServico}}</small>
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="descricao">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Descri√ß√£o </th>
                                    <td mat-cell *matCellDef="let servico" class="description-cell">
                                        {{servico.descricaoServicoAvulso}} </td>
                                </ng-container>

                                <ng-container matColumnDef="valor">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Valor Un. </th>
                                    <td mat-cell *matCellDef="let servico" class="amount-cell">
                                        {{ (servico.valorHoraAvulso || servico.valorUnidadeAvulso) | currency:'BRL' }}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="quantidade">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Qtd. </th>
                                    <td mat-cell *matCellDef="let servico" class="qty-cell"> {{ servico.quantidade |
                                        number:'1.2-2' }} </td>
                                </ng-container>

                                <ng-container matColumnDef="vlrDesconto">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Desconto </th>
                                    <td mat-cell *matCellDef="let servico" class="discount-cell">
                                        <span *ngIf="servico.descontoServico > 0">-{{ servico.descontoServico |
                                            currency:'BRL' }}</span>
                                        <span *ngIf="!(servico.descontoServico > 0)" class="no-discount">‚Äî</span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="vlrLiq">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
                                    <td mat-cell *matCellDef="let servico" class="total-cell"> {{servico.valorTotal |
                                        currency:'BRL' }} </td>
                                </ng-container>

                                <ng-container matColumnDef="acoes">
                                    <th mat-header-cell *matHeaderCellDef></th>
                                    <td mat-cell *matCellDef="let servico" class="actions-cell">
                                        <button mat-icon-button color="accent" (click)="openDiscountDialog(servico)"
                                            matTooltip="Aplicar desconto">
                                            <mat-icon>percent</mat-icon>
                                        </button>
                                        <button mat-icon-button color="warn" (click)="deleteItem(servico)"
                                            matTooltip="Remover item">
                                            <mat-icon>delete_outline</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="premium-row"></tr>
                            </table>

                            <div *ngIf="dataSource.data.length === 0" class="empty-state">
                                <mat-icon>receipt_long</mat-icon>
                                <p>Nenhum item adicionado ao or√ßamento ainda.</p>
                                <button mat-flat-button color="primary"
                                    (click)="openListaServicoDialog(Os?.sequencial)">Adicionar primeiro item</button>
                            </div>
                        </div>
                    </div>

                    <div id="orcamentoTotais" class="sidebar-card">
                        <div class="sidebar-header">
                            <span class="os-badge">OS #{{Os?.sequencial}}</span>
                            <div class="status-indicator" [ngClass]="'status-' + statusOs"></div>
                        </div>

                        <div class="sidebar-content">
                            <section class="sidebar-section">
                                <label class="section-label">Cliente</label>
                                <div class="client-info">
                                    <mat-icon>person</mat-icon>
                                    <span>{{Os?.cliente?.nome}}</span>
                                </div>
                            </section>

                            <section class="sidebar-section totals-section">
                                <label class="section-label">Resumo Financeiro</label>

                                <div class="totals-grid">
                                    <div class="total-item">
                                        <span class="total-label">Servi√ßos</span>
                                        <span class="total-value">R$ {{ totaisNota.valorTotalServico | number:'1.2-2'
                                            }}</span>
                                        <small class="discount-label" *ngIf="totaisNota.valorTotalDescontoServico > 0">
                                            Desc: R$ {{ totaisNota.valorTotalDescontoServico | number:'1.2-2' }}
                                        </small>
                                    </div>

                                    <div class="total-item">
                                        <span class="total-label">Produtos</span>
                                        <span class="total-value">R$ {{ totaisNota.valorTotalProdutos | number:'1.2-2'
                                            }}</span>
                                        <small class="discount-label" *ngIf="totaisNota.valorTotalDescontoProdutos > 0">
                                            Desc: R$ {{ totaisNota.valorTotalDescontoProdutos | number:'1.2-2' }}
                                        </small>
                                    </div>
                                </div>

                                <div class="grand-total">
                                    <span class="total-label">Valor Total</span>
                                    <span class="grand-total-value">R$ {{ totaisNota.valorTotalNota | number:'1.2-2'
                                        }}</span>
                                </div>
                            </section>

                            <section class="sidebar-section">
                                <label class="section-label">A√ß√µes do Or√ßamento</label>
                                <div class="sidebar-actions">
                                    <button mat-flat-button color="primary" (click)="sendOrcamento()"
                                        class="action-btn">
                                        <mat-icon>print</mat-icon> Imprimir
                                    </button>
                                    <button mat-flat-button class="action-btn whatsapp-btn" (click)="enviarWhatsApp()">
                                        <mat-icon>message</mat-icon> WhatsApp
                                    </button>
                                </div>
                            </section>

                            <section class="sidebar-section">
                                <label class="section-label">Status da OS</label>
                                <mat-form-field appearance="outline" class="status-select">
                                    <mat-select [(ngModel)]="statusOs" name="statusOS"
                                        (selectionChange)="alterStsOS($event)">
                                        <mat-option value="0">‚ö™ Nova</mat-option>
                                        <mat-option value="1">üîµ Em andamento</mat-option>
                                        <mat-option value="2">üü° Aguardando aprova√ß√£o</mat-option>
                                        <mat-option value="3">üü° Aguardando pe√ßas</mat-option>
                                        <mat-option value="4">üü° Aguardando retirada</mat-option>
                                        <mat-option value="5">üü¢ Or√ßamento aprovado</mat-option>
                                        <mat-option value="6">üî¥ Pendente</mat-option>
                                        <mat-option value="7">üü¢ Conclu√≠da</mat-option>
                                        <mat-option value="8">‚ö´ Cancelada</mat-option>
                                        <mat-option value="9">‚úÖ Encerrada</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </section>
                        </div>
                    </div>



                </div>



            </div>
        </mat-tab>

        <!-- Historico de movimenta√ß√£o -->
        <mat-tab label="Hist√≥rico">
            <div class="tab-content" style="padding: 20px;">
                <h3 style="margin-bottom: 20px; color: #555;">Linha do tempo da OS</h3>

                <div *ngIf="historico.length === 0"
                    style="text-align: center; color: #666; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <mat-icon
                        style="font-size: 48px; height: 48px; width: 48px; margin-bottom: 10px;">history</mat-icon>
                    <p>Nenhum hist√≥rico dispon√≠vel para esta OS ainda.</p>
                </div>

                <div class="history-container">
                    <div *ngFor="let item of historico" class="history-card">
                        <div class="history-dot"></div>
                        <div class="history-content">
                            <div class="history-header">
                                <span class="history-description">{{item.descricao}}</span>
                                <span class="history-date">{{item.dataAlteracao}}</span>
                            </div>
                            <div class="history-footer">
                                <span class="history-responsible">üë§ Respons√°vel: <b>{{item.responsavel}}</b></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>


    </mat-tab-group>

</div>