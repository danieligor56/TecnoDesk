<div class="container">
    <div class="loading-overlay" *ngIf="isLoading">
        <mat-spinner diameter="50"></mat-spinner>
    </div>

    <div class="titPage" style="padding:5px;margin-bottom: 10px;">
        <h1 id="osH1">Ordem de servi√ßo</h1>
    </div>

    <mat-tab-group mat-align-tabs="start" animationDuration="500ms" style="overflow: hidden;">




        <mat-tab label="Geral">
            <div class="tab-content standalone-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <div class="header-info">
                            <h3>Dados da Ordem de Servi√ßo</h3>
                            <span class="item-count">Aberta por: <b>{{Os?.colaborador?.nome}}</b></span>
                        </div>
                    </div>

                    <div class="card-body-wrapper">
                        <div class="os-main-layout">
                            <!-- Coluna da Esquerda: Cliente e Par√¢metros -->
                            <div class="os-data-column">
                                <section class="form-section">
                                    <h4 class="section-subtitle"><mat-icon>person</mat-icon> Dados do Cliente</h4>
                                    <div class="row">
                                        <div class="input-group">
                                            <label>Nome Completo</label>
                                            <input type="text" [value]="Os?.cliente?.nome" readonly>
                                        </div>
                                        <div class="input-group mini-input">
                                            <label>ID</label>
                                            <input type="text" [value]="Os?.cliente?.id" readonly>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="input-group">
                                            <label>Telefone / WhatsApp</label>
                                            <input type="text" [value]="Os?.cliente?.cel1" readonly>
                                        </div>
                                        <div class="input-group">
                                            <label>Email</label>
                                            <input type="text" [value]="Os?.cliente?.email" readonly>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="input-group">
                                            <label>Endere√ßo</label>
                                            <input type="text"
                                                [value]="Os?.cliente?.logradouro + ', ' + Os?.cliente?.numero" readonly>
                                        </div>
                                        <div class="input-group">
                                            <label>CPF/CNPJ</label>
                                            <input type="text" [value]="Os?.cliente?.documento" readonly>
                                        </div>
                                    </div>
                                </section>

                                <section class="form-section">
                                    <h4 class="section-subtitle"><mat-icon>settings</mat-icon> Par√¢metros da OS</h4>
                                    <div class="row">
                                        <div class="input-group">
                                            <mat-form-field appearance="outline" class="full-width-field">
                                                <mat-label>T√©cnico Respons√°vel</mat-label>
                                                <mat-select [(ngModel)]="responsalveTecnico.id"
                                                    (selectionChange)="onColaboradorChange($event.value)">
                                                    <mat-option *ngFor="let colaborador of colaboradores"
                                                        [value]="colaborador.id">
                                                        {{ colaborador.nome }}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                        <div class="input-group">
                                            <mat-form-field appearance="outline" class="full-width-field">
                                                <mat-label>Prioridade</mat-label>
                                                <mat-select [(ngModel)]="prioridadeos" name="prioridadeos">
                                                    <mat-option value="0">üìå Normal</mat-option>
                                                    <mat-option value="1">üî• Cr√≠tica / Urgente</mat-option>
                                                    <mat-option value="2">üîÑ Garantia</mat-option>
                                                    <mat-option value="3">‚è±Ô∏è Priorit√°ria</mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            <!-- Coluna da Direita: Reclama√ß√£o e Status -->
                            <div class="os-status-column">
                                <section class="form-section highlight-section">
                                    <h4 class="section-subtitle"><mat-icon>report_problem</mat-icon> Resumo do Problema
                                    </h4>

                                    <mat-form-field appearance="outline" class="full-width-field">
                                        <mat-label>Reclama√ß√£o do Cliente</mat-label>
                                        <textarea matInput rows="3" readonly>{{Os?.reclamacaoCliente}}</textarea>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="full-width-field">
                                        <mat-label>Testes Iniciais</mat-label>
                                        <textarea matInput rows="3" readonly>{{Os?.initTest}}</textarea>
                                    </mat-form-field>
                                </section>

                                <div class="action-footer">
                                    <button mat-flat-button color="primary" (click)="alterarTecnicoEPrioridade()"
                                        class="save-btn">
                                        <mat-icon>save</mat-icon> Atualizar Informa√ß√µes
                                    </button>
                                    <button mat-stroked-button color="basic" [routerLink]="['/os/list']"
                                        class="back-btn">
                                        <mat-icon>arrow_back</mat-icon> Voltar para Lista
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>

        <!-- Aba de Dados do Equipamento -->

        <mat-tab label="Equipamento">
            <div class="tab-content standalone-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <div class="header-info">
                            <h3>Dados do Equipamento</h3>
                            <span class="item-count">Identifica√ß√£o e estado f√≠sico</span>
                        </div>
                    </div>

                    <div class="card-body-wrapper">
                        <div class="os-main-layout">
                            <div class="os-data-column">
                                <section class="form-section">
                                    <h4 class="section-subtitle"><mat-icon>devices</mat-icon> Especifica√ß√µes</h4>
                                    <div class="row">
                                        <div class="input-group">
                                            <label>Aparelho</label>
                                            <input type="text" [value]="Os?.aparelhos" readonly>
                                        </div>
                                        <div class="input-group">
                                            <label>Marca</label>
                                            <input type="text" [value]="Os?.marcaAparelho" readonly>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="input-group">
                                            <label>Modelo</label>
                                            <input type="text" [value]="Os?.descricaoModelo" readonly>
                                        </div>
                                        <div class="input-group">
                                            <label>N√∫mero de S√©rie</label>
                                            <input type="text" [value]="Os?.snAparelho" readonly>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            <div class="os-status-column">
                                <section class="form-section highlight-section">
                                    <h4 class="section-subtitle"><mat-icon>assignment_turned_in</mat-icon> Check-list de
                                        Entrada</h4>
                                    <mat-form-field appearance="outline" class="full-width-field">
                                        <mat-label>Estado do aparelho e observa√ß√µes</mat-label>
                                        <textarea matInput rows="6" readonly>{{Os?.checkList}}</textarea>
                                    </mat-form-field>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>

        <!-- Orcamento -->
        <!-- Aba de Servi√ßo -->
        <mat-tab label="Diagn√≥stico">
            <div class="tab-content standalone-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <div class="header-info">
                            <h3>Diagn√≥stico e Laudo T√©cnico</h3>
                            <span class="item-count">Parecer do especialista</span>
                        </div>
                    </div>

                    <div class="card-body-wrapper">
                        <div class="os-main-layout">
                            <div class="os-data-column">
                                <section class="form-section">
                                    <h4 class="section-subtitle"><mat-icon>history</mat-icon> Contexto do Problema</h4>
                                    <div class="row">
                                        <div class="input-group">
                                            <label>Queixa do Cliente</label>
                                            <div class="readonly-text-box mini-height">{{Os?.reclamacaoCliente}}</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="input-group">
                                            <label>Resultado do Teste Inicial</label>
                                            <div class="readonly-text-box mini-height">{{Os?.initTest}}</div>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            <div class="os-status-column">
                                <section class="form-section highlight-section">
                                    <h4 class="section-subtitle"><mat-icon>psychology</mat-icon> Laudo de Diagn√≥stico
                                    </h4>
                                    <mat-form-field appearance="outline" class="full-width-field">
                                        <mat-label>Descri√ß√£o T√©cnica do Defeito e Solu√ß√£o</mat-label>
                                        <textarea matInput rows="8"
                                            placeholder="Descreva aqui o diagn√≥stico detalhado..."
                                            [(ngModel)]="Os.laudoTecnico" name="laudo"></textarea>
                                    </mat-form-field>
                                </section>

                                <div class="action-footer">
                                    <button mat-flat-button color="primary" (click)="updateDiagnosticoTecnico()"
                                        class="save-btn">
                                        <mat-icon>check_circle</mat-icon> Salvar Diagn√≥stico
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>

        <!-- Aba de Servi√ßo -->
        <mat-tab label="Or√ßamento">
            <div class="tab-content">
                <div class="servico-dados">
                    <div id="orcamento" class="content-card">
                        <div class="card-header">
                            <div class="header-info">
                                <h3>Itens do Or√ßamento</h3>
                                <span class="item-count">{{dataSource.data.length}} itens adicionados</span>
                            </div>
                            <div class="header-actions">
                                <button mat-stroked-button color="primary"
                                    (click)="openListaServicoDialog(Os?.sequencial)">
                                    <mat-icon>build</mat-icon> + Servi√ßo
                                </button>
                                <button mat-stroked-button color="primary"
                                    (click)="openListaProdutoDialog(Os?.sequencial)">
                                    <mat-icon>shopping_cart</mat-icon> + Produto
                                </button>
                                <button mat-flat-button color="accent" (click)="openKitCreateDialog(Os?.sequencial)">
                                    <mat-icon>bolt</mat-icon> Montar Kit
                                </button>
                                <button [matMenuTriggerFor]="menuAvulso" mat-icon-button>
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                                <mat-menu #menuAvulso="matMenu">
                                    <button mat-menu-item (click)="openServicoAvulso(Os?.sequencial)">
                                        <mat-icon>add</mat-icon> Servi√ßo Avulso
                                    </button>
                                    <button mat-menu-item (click)="openProdutoAvulso(Os?.sequencial)">
                                        <mat-icon>add</mat-icon> Produto Avulso
                                    </button>
                                </mat-menu>
                            </div>
                        </div>

                        <div class="table-container">
                            <table mat-table [dataSource]="dataSource" matSort class="premium-table">

                                <ng-container matColumnDef="nome">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Item </th>
                                    <td mat-cell *matCellDef="let servico" data-label="Item">
                                        <div class="item-cell">
                                            <mat-icon class="item-type-icon"
                                                [ngClass]="servico.produtoOuServico === 'SERVICO' ? 'icon-service' : 'icon-product'">
                                                {{servico.produtoOuServico === 'SERVICO' ? 'settings' : 'inventory_2'}}
                                            </mat-icon>
                                            <div class="item-details">
                                                <span class="item-name">{{servico.nomeServicoAvulso}}</span>
                                                <small class="item-category">{{servico.produtoOuServico}}</small>
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="descricao">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Descri√ß√£o </th>
                                    <td mat-cell *matCellDef="let servico" class="description-cell"
                                        data-label="Descri√ß√£o">
                                        {{servico.descricaoServicoAvulso}} </td>
                                </ng-container>

                                <ng-container matColumnDef="valor">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Valor Un. </th>
                                    <td mat-cell *matCellDef="let servico" class="amount-cell" data-label="Valor Un.">
                                        {{ (servico.valorHoraAvulso || servico.valorUnidadeAvulso) | currency:'BRL' }}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="quantidade">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Qtd. </th>
                                    <td mat-cell *matCellDef="let servico" class="qty-cell" data-label="Qtd."> {{
                                        servico.quantidade |
                                        number:'1.2-2' }} </td>
                                </ng-container>

                                <ng-container matColumnDef="vlrDesconto">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Desconto </th>
                                    <td mat-cell *matCellDef="let servico" class="discount-cell" data-label="Desconto">
                                        <span *ngIf="servico.descontoServico > 0">-{{ servico.descontoServico |
                                            currency:'BRL' }}</span>
                                        <span *ngIf="!(servico.descontoServico > 0)" class="no-discount">‚Äî</span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="vlrLiq">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
                                    <td mat-cell *matCellDef="let servico" class="total-cell" data-label="Total">
                                        {{servico.valorTotal |
                                        currency:'BRL' }} </td>
                                </ng-container>

                                <ng-container matColumnDef="acoes">
                                    <th mat-header-cell *matHeaderCellDef></th>
                                    <td mat-cell *matCellDef="let servico" class="actions-cell" data-label="A√ß√µes">
                                        <button mat-icon-button color="accent" (click)="openDiscountDialog(servico)"
                                            matTooltip="Aplicar desconto">
                                            <mat-icon>percent</mat-icon>
                                        </button>
                                        <button mat-icon-button color="warn" (click)="deleteItem(servico)"
                                            matTooltip="Remover item">
                                            <mat-icon>delete_outline</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="premium-row"></tr>
                            </table>

                            <div *ngIf="dataSource.data.length === 0" class="empty-state">
                                <mat-icon>receipt_long</mat-icon>
                                <p>Nenhum item adicionado ao or√ßamento ainda.</p>
                                <button mat-flat-button color="primary"
                                    (click)="openListaServicoDialog(Os?.sequencial)">Adicionar primeiro item</button>
                            </div>
                        </div>
                    </div>

                    <div id="orcamentoTotais" class="sidebar-card">
                        <div class="sidebar-header">
                            <span class="os-badge">OS #{{Os?.sequencial}}</span>
                            <div class="status-indicator" [ngClass]="'status-' + statusOs"></div>
                        </div>

                        <div class="sidebar-content">
                            <section class="sidebar-section">
                                <label class="section-label">Cliente</label>
                                <div class="client-info">
                                    <mat-icon>person</mat-icon>
                                    <span>{{Os?.cliente?.nome}}</span>
                                </div>
                            </section>

                            <section class="sidebar-section totals-section">
                                <label class="section-label">Resumo Financeiro</label>

                                <div class="totals-grid">
                                    <div class="total-item">
                                        <span class="total-label">Servi√ßos</span>
                                        <span class="total-value">R$ {{ totaisNota.valorTotalServico | number:'1.2-2'
                                            }}</span>
                                        <small class="discount-label" *ngIf="totaisNota.valorTotalDescontoServico > 0">
                                            Desc: R$ {{ totaisNota.valorTotalDescontoServico | number:'1.2-2' }}
                                        </small>
                                    </div>

                                    <div class="total-item">
                                        <span class="total-label">Produtos</span>
                                        <span class="total-value">R$ {{ totaisNota.valorTotalProdutos | number:'1.2-2'
                                            }}</span>
                                        <small class="discount-label" *ngIf="totaisNota.valorTotalDescontoProdutos > 0">
                                            Desc: R$ {{ totaisNota.valorTotalDescontoProdutos | number:'1.2-2' }}
                                        </small>
                                    </div>
                                </div>

                                <div class="grand-total">
                                    <span class="total-label">Valor Total</span>
                                    <span class="grand-total-value">R$ {{ totaisNota.valorTotalNota | number:'1.2-2'
                                        }}</span>
                                </div>
                            </section>

                            <section class="sidebar-section">
                                <label class="section-label">A√ß√µes do Or√ßamento</label>
                                <div class="sidebar-actions">
                                    <button mat-flat-button color="primary" (click)="sendOrcamento()"
                                        class="action-btn">
                                        <mat-icon>print</mat-icon> Imprimir
                                    </button>
                                    <button mat-flat-button class="action-btn whatsapp-btn" (click)="enviarWhatsApp()">
                                        <mat-icon>message</mat-icon> WhatsApp
                                    </button>
                                </div>
                            </section>

                            <section class="sidebar-section">
                                <label class="section-label">Status da OS</label>
                                <mat-form-field appearance="outline" class="status-select">
                                    <mat-select [(ngModel)]="statusOs" name="statusOS"
                                        (selectionChange)="alterStsOS($event)">
                                        <mat-option value="0">‚ö™ Nova</mat-option>
                                        <mat-option value="1">üîµ Em andamento</mat-option>
                                        <mat-option value="2">üü° Aguardando aprova√ß√£o</mat-option>
                                        <mat-option value="3">üü° Aguardando pe√ßas</mat-option>
                                        <mat-option value="4">üü° Aguardando retirada</mat-option>
                                        <mat-option value="5">üü¢ Or√ßamento aprovado</mat-option>
                                        <mat-option value="6">üî¥ Pendente</mat-option>
                                        <mat-option value="7">üü¢ Conclu√≠da</mat-option>
                                        <mat-option value="8">‚ö´ Cancelada</mat-option>
                                        <mat-option value="9">‚úÖ Encerrada</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </section>
                        </div>
                    </div>



                </div>



            </div>
        </mat-tab>

        <!-- Historico de movimenta√ß√£o -->
        <mat-tab label="Hist√≥rico">
            <div class="tab-content standalone-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <div class="header-info">
                            <h3>Linha do Tempo da OS</h3>
                            <span class="item-count">{{historico.length}} registros de movimenta√ß√£o</span>
                        </div>
                    </div>

                    <div class="card-body-wrapper">
                        <div *ngIf="historico.length === 0" class="empty-state">
                            <mat-icon>history</mat-icon>
                            <p>Nenhum hist√≥rico dispon√≠vel para esta OS ainda.</p>
                        </div>

                        <div class="history-container" *ngIf="historico.length > 0">
                            <div *ngFor="let item of historico" class="history-card">
                                <div class="history-dot"></div>
                                <div class="history-content">
                                    <div class="history-header">
                                        <span class="history-description">{{item.descricao}}</span>
                                        <span class="history-date">{{item.dataAlteracao}}</span>
                                    </div>
                                    <div class="history-footer">
                                        <span class="history-responsible">
                                            <mat-icon>person</mat-icon>
                                            Respons√°vel: <b>{{item.responsavel}}</b>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>


    </mat-tab-group>

</div>